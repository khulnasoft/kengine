#!/bin/sh
#
# PROVIDE: kengine
# REQUIRE: networking
# KEYWORD: shutdown

#
# Add the following lines to /etc/rc.conf to enable kengine:
# kengine_enable (bool):        Set to "NO" by default.
#                             Set it to "YES" to enable kengine
#
# kengine_cert_email (str):     Set to "" by default.
#                             Defines the SSL certificate issuer email. By providing an
#                             email address you automatically agree to letsencrypt.org's
#                             general terms and conditions
#
# kengine_bin_path (str):       Set to "/usr/local/bin/kengine" by default.
#                             Provides the path to the kengine server executable
#
# kengine_cpu (str):            Set to "99%" by default.
#                             Configures, how much CPU capacity kengine may gain
#
# kengine_config_path (str):    Set to "/usr/local/www/Kenginefile" by default.
#                             Defines the path for the configuration file kengine will load on boot
#
# kengine_user (str):           Set to "root" by default.
#                             Defines the user that kengine will run on
#
# kengine_group (str):  	      Set to "wheel" by default.
#                             Defines the group that kengine files will be attached to
#
# kengine_syslog_facility (str) Set to "local7" by default.
#                             Defines the syslog facility used to log output from the kengine process.
#                             This is NOT the web access log.
#
# kengine_syslog_level (str)    Set to "notice" by default.
#                             Defines the syslog level used to log output from the kengine process.
#                             This is NOT the web access log.
#
# kengine_env (str)	      Set to "" by default.
#			      This allows environment variable to be set that may be required, for example when using "DNS Challenge" account credentials are required.
#			      e.g. (in your rc.conf)   kengine_env="CLOUDFLARE_EMAIL=me@domain.com CLOUDFLARE_API_KEY=my_api_key"
#

. /etc/rc.subr

name="kengine"
rcvar="${name}_enable"

load_rc_config ${name}

: ${kengine_enable:="NO"}
: ${kengine_cert_email=""}
: ${kengine_bin_path="/usr/local/bin/kengine"}
: ${kengine_cpu="99%"} # was a bug for me that caused a crash within jails
: ${kengine_config_path="/usr/local/www/Kenginefile"}
: ${kengine_syslog_facility="local7"}
: ${kengine_syslog_level="notice"}
: ${kengine_user="root"}
: ${kengine_group="wheel"}
: ${kengine_flags=""}
: ${kengine_options="-cpu ${kengine_cpu} -log stdout -conf ${kengine_config_path} -agree -email ${kengine_cert_email} ${kengine_flags}"}

if [ "$kengine_cert_email" = "" ]
then
    echo "rc variable \$kengine_cert_email is not set. Please provide a valid SSL certificate issuer email."
    exit 1
fi

pidfile="/var/run/${name}.pid"
procname="${kengine_bin_path}" #enabled builtin pid checking for start / stop
command="/usr/sbin/daemon"
command_args="-p ${pidfile} -T ${name} -l ${kengine_syslog_facility} -s ${kengine_syslog_level} /usr/bin/env ${kengine_env} ${procname} ${kengine_options} < /dev/null"

start_precmd="kengine_startprecmd"

kengine_startprecmd()
{
	# Clear flags provided by kengine_flags to prevent them being passed to daemon(8)
	rc_flags=""

	if [ ! -e "${pidfile}" ]; then
		install -m 644 -o "${kengine_user}" -g "${kengine_group}" "/dev/null" "${pidfile}"
	fi
}

required_files="${kengine_config_path}"

run_rc_command "$1"

